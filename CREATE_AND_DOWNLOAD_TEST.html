<!DOCTYPE html>
<html>
<head>
    <title>Create & Download Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .test { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        button { background: #2196F3; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; margin: 5px; }
        button:hover { background: #1976D2; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üß™ Create Session Plan & Download Test</h1>
    
    <div class="test">
        <h3>Step 1: Create Session Plan</h3>
        <button onclick="createSessionPlan()">Create Test Session Plan</button>
        <div id="create-result"></div>
    </div>

    <div class="test">
        <h3>Step 2: Download Session Plan</h3>
        <button onclick="downloadSessionPlan()" id="download-btn" disabled>Download Created Plan</button>
        <div id="download-result"></div>
    </div>

    <script>
        let createdPlanId = null;

        async function createSessionPlan() {
            const result = document.getElementById('create-result');
            result.innerHTML = '<p>Creating session plan...</p>';
            
            const testData = {
                user_phone: "+250789751597",
                sector: "ICT",
                sub_sector: "Software Development",
                trade: "Programming",
                qualification_title: "Certificate in Programming",
                rqf_level: "Level 4",
                module_code_title: "PRG101 - Introduction to C Programming",
                term: "Term 1",
                week: "Week 5",
                date: "2024-01-15",
                trainer_name: "Test Trainer",
                class_name: "Class A",
                number_of_trainees: "25",
                learning_outcomes: "Students will understand WHILE loops",
                indicative_contents: "WHILE loop syntax, examples, exercises",
                topic_of_session: "Application of WHILE loop in C",
                duration: "45 minutes",
                facilitation_techniques: "Trainer Guided"
            };
            
            try {
                const response = await fetch('https://rtb-document-planner.onrender.com/session-plans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    createdPlanId = data.id;
                    result.innerHTML = `
                        <p class="success">‚úÖ Session plan created successfully!</p>
                        <p><strong>Plan ID:</strong> ${data.id}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    document.getElementById('download-btn').disabled = false;
                } else {
                    result.innerHTML = `
                        <p class="error">‚ùå Failed to create session plan</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function downloadSessionPlan() {
            if (!createdPlanId) {
                alert('Please create a session plan first!');
                return;
            }

            const result = document.getElementById('download-result');
            result.innerHTML = '<p>Downloading...</p>';
            
            try {
                const url = `https://rtb-document-planner.onrender.com/session-plans/${createdPlanId}/download?phone=%2B250789751597`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `RTB_Session_Plan_${createdPlanId}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                    result.innerHTML = `
                        <p class="success">‚úÖ Download successful!</p>
                        <p>File size: ${blob.size} bytes</p>
                        <p>Check your Downloads folder for the .docx file</p>
                    `;
                } else {
                    const text = await response.text();
                    result.innerHTML = `
                        <p class="error">‚ùå Download failed!</p>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <pre>${text}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
