<!DOCTYPE html>
<html>
<head>
    <title>Session Plan Wizard - Modern</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 2rem; }
        .wizard-container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .wizard-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; }
        .wizard-header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .progress-bar { display: flex; justify-content: space-between; margin: 2rem 0; }
        .progress-step { flex: 1; text-align: center; position: relative; }
        .progress-step::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: rgba(255,255,255,0.3); z-index: 0; }
        .progress-step:first-child::before { left: 50%; }
        .progress-step:last-child::before { right: 50%; }
        .progress-step .step-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.3); margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: bold; position: relative; z-index: 1; transition: all 0.3s; }
        .progress-step.active .step-circle { background: white; color: #667eea; transform: scale(1.2); }
        .progress-step.completed .step-circle { background: #10b981; color: white; }
        .progress-step .step-label { font-size: 0.75rem; opacity: 0.8; }
        .wizard-body { padding: 2rem; }
        .step-content { display: none; }
        .step-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        label .required { color: #ef4444; }
        input, select, textarea { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .btn { padding: 0.75rem 2rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .wizard-footer { padding: 1.5rem 2rem; background: #f9fafb; display: flex; justify-content: space-between; }
        .file-upload { border: 2px dashed #d1d5db; border-radius: 10px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s; }
        .file-upload:hover { border-color: #667eea; background: #f0f4ff; }
        .file-upload input { display: none; }
        .success-message { background: #10b981; color: white; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="wizard-container">
        <div class="wizard-header">
            <h1><i class="fas fa-graduation-cap"></i> RTB Session Plan Wizard</h1>
            <p>Create professional session plans in 4 easy steps</p>
            <div class="progress-bar">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Basic Info</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Location</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Session Details</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Content</div>
                </div>
            </div>
        </div>

        <div class="wizard-body">
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> Session plan created successfully! Downloading...
            </div>

            <form id="wizardForm">
                <!-- Step 1: Basic Info -->
                <div class="step-content active" data-step="1">
                    <h2 style="margin-bottom: 1.5rem; color: #667eea;">Step 1: Basic Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-building"></i> Sector <span class="required">*</span></label>
                            <input type="text" name="sector" required placeholder="e.g., ICT">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-tools"></i> Trade <span class="required">*</span></label>
                            <input type="text" name="trade" required placeholder="e.g., Programming">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-layer-group"></i> RQF Level <span class="required">*</span></label>
                            <select name="rqf_level" required>
                                <option value="">Select Level</option>
                                <option value="Level 1">Level 1</option>
                                <option value="Level 2">Level 2</option>
                                <option value="Level 3">Level 3</option>
                                <option value="Level 4">Level 4</option>
                                <option value="Level 5">Level 5</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-user-tie"></i> Trainer Name <span class="required">*</span></label>
                            <input type="text" name="trainer_name" required placeholder="e.g., John Doe">
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-book"></i> Module Code & Title <span class="required">*</span></label>
                        <input type="text" name="module_code_title" required placeholder="e.g., PRG101 - C Programming">
                    </div>
                </div>

                <!-- Step 2: Location -->
                <div class="step-content" data-step="2">
                    <h2 style="margin-bottom: 1.5rem; color: #667eea;">Step 2: School Location</h2>
                    <div class="form-group">
                        <label><i class="fas fa-school"></i> School Name <span class="required">*</span></label>
                        <input type="text" name="school_name" required placeholder="e.g., IPRC Kigali">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-map-marked-alt"></i> Province <span class="required">*</span></label>
                            <select name="province" id="provinceSelect" required>
                                <option value="">Select Province</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map-marker-alt"></i> District <span class="required">*</span></label>
                            <select name="district" id="districtSelect" required disabled>
                                <option value="">Select District</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Sector <span class="required">*</span></label>
                            <select name="sector_location" id="sectorSelect" required disabled>
                                <option value="">Select Sector</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-location-arrow"></i> Cell <span class="required">*</span></label>
                            <select name="cell" id="cellSelect" required disabled>
                                <option value="">Select Cell</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-home"></i> Village <span class="required">*</span></label>
                        <select name="village" id="villageSelect" required disabled>
                            <option value="">Select Village</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-image"></i> School Logo (Optional)</label>
                        <div class="file-upload" onclick="document.getElementById('schoolLogoInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #667eea; margin-bottom: 0.5rem;"></i>
                            <p>Click to upload school logo (PNG, JPG)</p>
                            <input type="file" id="schoolLogoInput" accept="image/png,image/jpeg,image/jpg">
                        </div>
                    </div>
                </div>

                <!-- Step 3: Session Details -->
                <div class="step-content" data-step="3">
                    <h2 style="margin-bottom: 1.5rem; color: #667eea;">Step 3: Session Details</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Term <span class="required">*</span></label>
                            <select name="term" required>
                                <option value="">Select Term</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar-week"></i> Week <span class="required">*</span></label>
                            <input type="text" name="week" required placeholder="e.g., Week 4">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-calendar-day"></i> Date <span class="required">*</span></label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-clock"></i> Duration (minutes) <span class="required">*</span></label>
                            <input type="number" name="duration" required min="40" max="120" value="40">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-users"></i> Number of Trainees <span class="required">*</span></label>
                            <input type="number" name="number_of_trainees" required min="1" placeholder="e.g., 25">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-tag"></i> Class Name <span class="required">*</span></label>
                            <input type="text" name="class_name" required placeholder="e.g., L4CSA-A">
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-chalkboard-teacher"></i> Facilitation Technique <span class="required">*</span></label>
                        <select name="facilitation_techniques" required>
                            <option value="">Select Technique</option>
                            <option value="Trainer Guided">Trainer Guided</option>
                            <option value="Group Discussion">Group Discussion</option>
                            <option value="Simulation">Simulation</option>
                            <option value="Brainstorming">Brainstorming</option>
                            <option value="Jigsaw">Jigsaw</option>
                            <option value="Experiential Learning">Experiential Learning</option>
                        </select>
                    </div>
                </div>

                <!-- Step 4: Content -->
                <div class="step-content" data-step="4">
                    <h2 style="margin-bottom: 1.5rem; color: #667eea;">Step 4: Session Content</h2>
                    <div class="form-group">
                        <label><i class="fas fa-bullseye"></i> Topic of Session <span class="required">*</span></label>
                        <input type="text" name="topic_of_session" required placeholder="e.g., Variables and Data Types">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-users-cog"></i> Range <span class="required">*</span></label>
                        <input type="text" name="range" required placeholder="e.g., All learners in Level 4 Programming class">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-target"></i> Learning Outcomes <span class="required">*</span></label>
                        <textarea name="learning_outcomes" rows="3" required placeholder="Describe what learners will be able to do after this session..."></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-list-ul"></i> Indicative Contents <span class="required">*</span></label>
                        <textarea name="indicative_contents" rows="3" required placeholder="• Key point 1&#10;• Key point 2&#10;• Key point 3"></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-paperclip"></i> Appendix (Optional)</label>
                        <textarea name="appendix" rows="2" placeholder="e.g., PPT slides, Task sheets, Assessment rubrics"></textarea>
                    </div>
                </div>
            </form>
        </div>

        <div class="wizard-footer">
            <button type="button" class="btn btn-secondary" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                Next <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <script src="location-handler.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        let currentStep = 1;
        let currentUser = null;

        function validateUser() {
            try {
                const session = getCurrentSession();
                if (!session || !session.name || !session.phone) {
                    throw new Error('No valid session found');
                }
                currentUser = session;
                return session;
            } catch (error) {
                alert('Please login first to access this page');
                window.location.href = 'login.html';
                return null;
            }
        }

        function changeStep(direction) {
            const steps = document.querySelectorAll('.step-content');
            const currentStepElement = steps[currentStep - 1];
            
            // Validate current step before moving forward
            if (direction === 1) {
                const inputs = currentStepElement.querySelectorAll('input[required], select[required], textarea[required]');
                for (let input of inputs) {
                    if (!input.value.trim()) {
                        input.focus();
                        alert('Please fill in all required fields');
                        return;
                    }
                }
            }
            
            // Update step
            currentStep += direction;
            
            if (currentStep < 1) currentStep = 1;
            if (currentStep > 4) {
                submitForm();
                return;
            }
            
            // Update UI
            steps.forEach((step, index) => {
                step.classList.remove('active');
                if (index === currentStep - 1) {
                    step.classList.add('active');
                }
            });
            
            // Update progress
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index < currentStep - 1) {
                    step.classList.add('completed');
                } else if (index === currentStep - 1) {
                    step.classList.add('active');
                }
            });
            
            // Update buttons
            document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'block';
            document.getElementById('nextBtn').innerHTML = currentStep === 4 ? '<i class="fas fa-magic"></i> Generate Session Plan' : 'Next <i class="fas fa-arrow-right"></i>';
        }

        async function submitForm() {
            const formData = new FormData(document.getElementById('wizardForm'));
            const data = Object.fromEntries(formData);
            
            // Handle school logo
            const schoolLogoFile = document.getElementById('schoolLogoInput').files[0];
            if (schoolLogoFile) {
                try {
                    data.school_logo = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(schoolLogoFile);
                    });
                } catch (error) {
                    console.error('Error reading logo:', error);
                }
            }
            
            data.user_phone = currentUser.phone;
            data.level = data.rqf_level;
            
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = true;
            nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            
            try {
                const response = await fetch(`${API_BASE}/session-plans`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('successMessage').style.display = 'block';
                    
                    // Download
                    const downloadUrl = `${API_BASE}/session-plans/${result.id}/download?phone=${encodeURIComponent(currentUser.phone)}`;
                    const dlResponse = await fetch(downloadUrl);
                    
                    if (dlResponse.ok) {
                        const blob = await dlResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `RTB_Session_Plan_${result.id}.docx`;
                        link.click();
                        window.URL.revokeObjectURL(url);
                        
                        setTimeout(() => {
                            window.location.href = 'teacher-dashboard.html';
                        }, 2000);
                    }
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to create session plan'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                nextBtn.disabled = false;
                nextBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Session Plan';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!validateUser()) return;
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
        });
    </script>
</body>
</html>
