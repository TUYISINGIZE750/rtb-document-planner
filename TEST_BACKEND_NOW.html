<!DOCTYPE html>
<html>
<head>
    <title>Backend Test - RTB Planner</title>
    <style>
        body { font-family: monospace; padding: 2rem; background: #1e1e1e; color: #00ff00; }
        .test { margin: 1rem 0; padding: 1rem; border: 1px solid #333; background: #2d2d2d; }
        .pass { color: #00ff00; }
        .fail { color: #ff0000; }
        button { padding: 1rem 2rem; background: #0066cc; color: white; border: none; cursor: pointer; font-size: 1rem; margin: 0.5rem; }
        button:hover { background: #0052a3; }
        pre { background: #000; padding: 1rem; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ RTB Backend Test Suite</h1>
    
    <div class="test">
        <h2>Test 1: Backend Health Check</h2>
        <button onclick="testBackendHealth()">Run Test</button>
        <pre id="test1Result">Click button to test...</pre>
    </div>
    
    <div class="test">
        <h2>Test 2: Login Test</h2>
        <button onclick="testLogin()">Run Test</button>
        <pre id="test2Result">Click button to test...</pre>
    </div>
    
    <div class="test">
        <h2>Test 3: Create Session Plan</h2>
        <button onclick="testCreateSessionPlan()">Run Test</button>
        <pre id="test3Result">Click button to test...</pre>
    </div>
    
    <div class="test">
        <h2>Test 4: Download Session Plan</h2>
        <input type="number" id="planId" placeholder="Enter plan ID" style="padding: 0.5rem; margin-right: 0.5rem;">
        <button onclick="testDownload()">Run Test</button>
        <pre id="test4Result">Enter plan ID and click button...</pre>
    </div>

    <script>
        const API_BASE = 'https://rtb-document-planner.onrender.com';
        let authToken = null;
        let userPhone = '+250789751597';

        async function testBackendHealth() {
            const result = document.getElementById('test1Result');
            result.textContent = '‚è≥ Testing backend health...';
            
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                
                result.innerHTML = `‚úÖ PASS - Backend is online!\n\nResponse:\n${JSON.stringify(data, null, 2)}`;
                result.className = 'pass';
            } catch (error) {
                result.innerHTML = `‚ùå FAIL - Backend unreachable!\n\nError: ${error.message}`;
                result.className = 'fail';
            }
        }

        async function testLogin() {
            const result = document.getElementById('test2Result');
            result.textContent = '‚è≥ Testing login...';
            
            try {
                const response = await fetch(`${API_BASE}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: '+250789751597',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `‚úÖ PASS - Login successful!\n\nUser: ${data.user.name}\nRole: ${data.user.role}\nPremium: ${data.user.is_premium}`;
                    result.className = 'pass';
                } else {
                    result.innerHTML = `‚ùå FAIL - Login failed!\n\nError: ${data.detail}`;
                    result.className = 'fail';
                }
            } catch (error) {
                result.innerHTML = `‚ùå FAIL - Login request failed!\n\nError: ${error.message}`;
                result.className = 'fail';
            }
        }

        async function testCreateSessionPlan() {
            const result = document.getElementById('test3Result');
            result.textContent = '‚è≥ Creating session plan with AI content...';
            
            try {
                const testData = {
                    user_phone: '+250789751597',
                    sector: 'ICT & MULTIMEDIA',
                    sub_sector: 'Software Development',
                    trade: 'Software Development',
                    qualification_title: 'Advanced Diploma in Software Development',
                    rqf_level: 'Level 4',
                    module_code_title: 'CSA-M01: Introduction to Programming',
                    term: 'Term 1',
                    week: 'Week 4',
                    date: new Date().toISOString().split('T')[0],
                    trainer_name: 'Test Teacher',
                    class_name: 'L4CSA-A',
                    number_of_trainees: '25',
                    learning_outcomes: 'Students will understand variables and data types in C programming',
                    indicative_contents: '‚Ä¢ Variables declaration\n‚Ä¢ Data types (int, float, char)\n‚Ä¢ Type conversion',
                    topic_of_session: 'Variables and Data Types in C',
                    duration: '40',
                    facilitation_techniques: 'Brainstorming'
                };
                
                const response = await fetch(`${API_BASE}/session-plans`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.id) {
                    result.innerHTML = `‚úÖ PASS - Session plan created!\n\nPlan ID: ${data.id}\nMessage: ${data.message}\n\nüì• Use this ID in Test 4 to download the document.`;
                    result.className = 'pass';
                    document.getElementById('planId').value = data.id;
                } else {
                    result.innerHTML = `‚ùå FAIL - Creation failed!\n\nError: ${data.detail || 'Unknown error'}`;
                    result.className = 'fail';
                }
            } catch (error) {
                result.innerHTML = `‚ùå FAIL - Request failed!\n\nError: ${error.message}`;
                result.className = 'fail';
            }
        }

        async function testDownload() {
            const result = document.getElementById('test4Result');
            const planId = document.getElementById('planId').value;
            
            if (!planId) {
                result.textContent = '‚ùå Please enter a plan ID';
                return;
            }
            
            result.textContent = `‚è≥ Downloading plan ${planId}...`;
            
            try {
                const downloadUrl = `${API_BASE}/session-plans/${planId}/download?phone=${encodeURIComponent(userPhone)}`;
                
                const response = await fetch(downloadUrl);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `RTB_Session_Plan_${planId}_TEST.docx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    result.innerHTML = `‚úÖ PASS - Download successful!\n\nFile size: ${(blob.size / 1024).toFixed(2)} KB\nType: ${blob.type}\n\nüìÑ Check your Downloads folder for the file.`;
                    result.className = 'pass';
                } else {
                    const errorText = await response.text();
                    result.innerHTML = `‚ùå FAIL - Download failed!\n\nStatus: ${response.status}\nError: ${errorText}`;
                    result.className = 'fail';
                }
            } catch (error) {
                result.innerHTML = `‚ùå FAIL - Download request failed!\n\nError: ${error.message}`;
                result.className = 'fail';
            }
        }
    </script>
</body>
</html>
