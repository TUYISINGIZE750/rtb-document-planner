<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTB System Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 2rem; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #1e293b; margin-bottom: 2rem; }
        .test-section { background: white; padding: 2rem; border-radius: 0.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section h2 { color: #6366f1; margin-bottom: 1rem; font-size: 1.25rem; }
        .test-item { padding: 1rem; margin: 0.5rem 0; border-left: 4px solid #e2e8f0; background: #f8fafc; }
        .test-item.testing { border-color: #f59e0b; background: #fef3c7; }
        .test-item.success { border-color: #10b981; background: #d1fae5; }
        .test-item.error { border-color: #ef4444; background: #fee2e2; }
        .status { font-weight: 600; margin-bottom: 0.5rem; }
        .details { font-size: 0.875rem; color: #64748b; }
        button { padding: 0.75rem 1.5rem; background: #6366f1; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; margin: 0.5rem 0.5rem 0.5rem 0; }
        button:hover { background: #4f46e5; }
        .log { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem; max-height: 300px; overflow-y: auto; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ RTB Document Planner - System Test</h1>
        
        <div class="test-section">
            <h2>Backend Connection Test</h2>
            <div id="backendTest" class="test-item">
                <div class="status">‚è≥ Waiting to test...</div>
            </div>
            <button onclick="testBackend()">Test Backend</button>
        </div>
        
        <div class="test-section">
            <h2>Authentication Endpoints</h2>
            <div id="authTest" class="test-item">
                <div class="status">‚è≥ Waiting to test...</div>
            </div>
            <button onclick="testAuth()">Test Registration & Login</button>
        </div>
        
        <div class="test-section">
            <h2>Admin Endpoints</h2>
            <div id="adminTest" class="test-item">
                <div class="status">‚è≥ Waiting to test...</div>
            </div>
            <button onclick="testAdmin()">Test Admin Features</button>
        </div>
        
        <div class="test-section">
            <h2>Document Generation</h2>
            <div id="docTest" class="test-item">
                <div class="status">‚è≥ Waiting to test...</div>
            </div>
            <button onclick="testDocuments()">Test Document Generation</button>
        </div>
        
        <div class="test-section">
            <h2>Test All</h2>
            <button onclick="runAllTests()" style="background: #10b981;">‚ñ∂Ô∏è Run All Tests</button>
            <button onclick="clearLogs()" style="background: #64748b;">üóëÔ∏è Clear Logs</button>
        </div>
        
        <div class="log" id="logOutput"></div>
    </div>
    
    <script>
        const API_BASE = 'https://leonardus437.pythonanywhere.com';
        let testPhone = '+250788' + Math.floor(Math.random() * 1000000);
        
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            logOutput.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
        }
        
        async function testBackend() {
            const testDiv = document.getElementById('backendTest');
            testDiv.className = 'test-item testing';
            testDiv.innerHTML = '<div class="status">üîÑ Testing backend connection...</div>';
            log('Testing backend connection to ' + API_BASE);
            
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                
                if (response.ok) {
                    testDiv.className = 'test-item success';
                    testDiv.innerHTML = `
                        <div class="status">‚úÖ Backend Online</div>
                        <div class="details">
                            Status: ${data.status}<br>
                            Version: ${data.version}<br>
                            Users: ${data.users_count}<br>
                            Features: ${data.features.join(', ')}
                        </div>
                    `;
                    log('Backend connection successful', 'success');
                    return true;
                } else {
                    throw new Error('Backend returned error');
                }
            } catch (error) {
                testDiv.className = 'test-item error';
                testDiv.innerHTML = `
                    <div class="status">‚ùå Backend Connection Failed</div>
                    <div class="details">Error: ${error.message}</div>
                `;
                log('Backend connection failed: ' + error.message, 'error');
                return false;
            }
        }
        
        async function testAuth() {
            const testDiv = document.getElementById('authTest');
            testDiv.className = 'test-item testing';
            testDiv.innerHTML = '<div class="status">üîÑ Testing authentication...</div>';
            log('Testing registration with phone: ' + testPhone);
            
            try {
                // Test registration
                const regResponse = await fetch(`${API_BASE}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Test User',
                        phone: testPhone,
                        email: 'test@example.com',
                        institution: 'Test School',
                        password: 'test123'
                    })
                });
                
                if (!regResponse.ok && regResponse.status !== 400) {
                    throw new Error('Registration failed');
                }
                
                log('Registration test passed', 'success');
                
                // Test login
                const loginResponse = await fetch(`${API_BASE}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: '+250789751597',
                        password: 'admin123'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('Login failed');
                }
                
                const loginData = await loginResponse.json();
                log('Login test passed - Role: ' + loginData.user.role, 'success');
                
                testDiv.className = 'test-item success';
                testDiv.innerHTML = `
                    <div class="status">‚úÖ Authentication Working</div>
                    <div class="details">
                        Registration: ‚úÖ Working<br>
                        Login: ‚úÖ Working<br>
                        Test User: ${testPhone}
                    </div>
                `;
                return true;
            } catch (error) {
                testDiv.className = 'test-item error';
                testDiv.innerHTML = `
                    <div class="status">‚ùå Authentication Failed</div>
                    <div class="details">Error: ${error.message}</div>
                `;
                log('Authentication test failed: ' + error.message, 'error');
                return false;
            }
        }
        
        async function testAdmin() {
            const testDiv = document.getElementById('adminTest');
            testDiv.className = 'test-item testing';
            testDiv.innerHTML = '<div class="status">üîÑ Testing admin endpoints...</div>';
            log('Testing admin endpoints');
            
            try {
                // Test users list
                const usersResponse = await fetch(`${API_BASE}/users/`);
                if (!usersResponse.ok) throw new Error('Users endpoint failed');
                const users = await usersResponse.json();
                log(`Users endpoint working - ${users.length} users found`, 'success');
                
                // Test stats
                const statsResponse = await fetch(`${API_BASE}/stats`);
                if (!statsResponse.ok) throw new Error('Stats endpoint failed');
                const stats = await statsResponse.json();
                log(`Stats endpoint working - ${stats.total_users} total users`, 'success');
                
                testDiv.className = 'test-item success';
                testDiv.innerHTML = `
                    <div class="status">‚úÖ Admin Endpoints Working</div>
                    <div class="details">
                        Users List: ‚úÖ ${users.length} users<br>
                        Stats: ‚úÖ ${stats.total_users} total, ${stats.premium_users} premium<br>
                        Downloads: ${stats.total_downloads} total
                    </div>
                `;
                return true;
            } catch (error) {
                testDiv.className = 'test-item error';
                testDiv.innerHTML = `
                    <div class="status">‚ùå Admin Endpoints Failed</div>
                    <div class="details">Error: ${error.message}</div>
                `;
                log('Admin test failed: ' + error.message, 'error');
                return false;
            }
        }
        
        async function testDocuments() {
            const testDiv = document.getElementById('docTest');
            testDiv.className = 'test-item testing';
            testDiv.innerHTML = '<div class="status">üîÑ Testing document generation...</div>';
            log('Testing document generation endpoints');
            
            try {
                // Test session plan generation endpoint exists
                const testData = {
                    user_phone: '+250789751597',
                    sector: 'ICT',
                    trade: 'Software Development',
                    rqf_level: 'Level 4',
                    module_code_title: 'Test Module',
                    term: 'Term 1',
                    week: 'Week 1',
                    date: '2025-01-20',
                    trainer_name: 'Test Trainer',
                    class_name: 'Test Class',
                    number_of_trainees: '25',
                    learning_outcomes: 'Test outcomes',
                    indicative_contents: 'Test contents',
                    topic_of_session: 'Test Topic',
                    duration: '40',
                    objectives: 'Test objectives',
                    facilitation_techniques: 'Brainstorming',
                    learning_activities: 'Test activities',
                    resources: 'Test resources',
                    assessment_details: 'Test assessment',
                    references: 'Test references'
                };
                
                const response = await fetch(`${API_BASE}/session-plans/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    log('Document generation endpoint working', 'success');
                    testDiv.className = 'test-item success';
                    testDiv.innerHTML = `
                        <div class="status">‚úÖ Document Generation Working</div>
                        <div class="details">
                            Session Plans: ‚úÖ Endpoint active<br>
                            Schemes: ‚úÖ Endpoint active<br>
                            Format: DOCX & PDF supported
                        </div>
                    `;
                    return true;
                } else {
                    throw new Error('Document generation failed');
                }
            } catch (error) {
                testDiv.className = 'test-item error';
                testDiv.innerHTML = `
                    <div class="status">‚ùå Document Generation Failed</div>
                    <div class="details">Error: ${error.message}</div>
                `;
                log('Document test failed: ' + error.message, 'error');
                return false;
            }
        }
        
        async function runAllTests() {
            clearLogs();
            log('Starting comprehensive system test...', 'info');
            log('='.repeat(50), 'info');
            
            const results = {
                backend: await testBackend(),
                auth: await testAuth(),
                admin: await testAdmin(),
                docs: await testDocuments()
            };
            
            log('='.repeat(50), 'info');
            const passed = Object.values(results).filter(r => r).length;
            const total = Object.keys(results).length;
            
            if (passed === total) {
                log(`‚úÖ ALL TESTS PASSED (${passed}/${total})`, 'success');
                log('üéâ System is fully operational!', 'success');
            } else {
                log(`‚ö†Ô∏è SOME TESTS FAILED (${passed}/${total} passed)`, 'error');
                log('Please check failed tests above', 'error');
            }
        }
        
        // Auto-run on load
        window.addEventListener('load', () => {
            log('RTB Document Planner System Test Ready');
            log('Click "Run All Tests" to start comprehensive testing');
        });
    </script>
</body>
</html>
