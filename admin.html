<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>RTB Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .header { background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .header h1 { color: #333; margin-bottom: 0.5rem; }
        .header p { color: #666; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 2rem; border-radius: 12px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #333; }
        .stat-label { color: #666; margin-top: 0.5rem; font-size: 0.9rem; }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .users-section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .controls-section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .search-bar { width: 100%; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 1rem; font-size: 1rem; }
        .user-item { padding: 1.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }
        .user-item:hover { background: #f8f9fa; }
        .user-info { flex: 1; }
        .user-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .user-details { color: #666; font-size: 0.9rem; line-height: 1.4; }
        .user-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .status { padding: 1rem; margin: 1rem 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 2rem; width: 90%; max-width: 500px; border-radius: 12px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .close { font-size: 2rem; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem; border: 2px solid #e0e0e0; border-radius: 6px; }
        .notification-panel { margin-bottom: 2rem; }
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; }
        .action-card { padding: 1.5rem; background: #f8f9fa; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .action-card:hover { background: #e9ecef; transform: translateY(-2px); }
        .badge { padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .badge-premium { background: #ffd700; color: #333; }
        .badge-active { background: #28a745; color: white; }
        .badge-inactive { background: #dc3545; color: white; }
        .badge-admin { background: #6f42c1; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è RTB Admin Dashboard</h1>
            <p>Backend: <strong>https://leonardus437.pythonanywhere.com</strong></p>
            <div id="connectionStatus" class="status">Testing connection...</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="premiumUsers">-</div>
                <div class="stat-label">Premium Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeUsers">-</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalDownloads">-</div>
                <div class="stat-label">Total Downloads</div>
            </div>
        </div>

        <div class="main-content">
            <div class="users-section">
                <h2>üë• User Management</h2>
                <input type="text" class="search-bar" id="searchUsers" placeholder="üîç Search users by name, phone, or institution...">
                <div id="usersList">Loading users...</div>
            </div>

            <div class="controls-section">
                <div class="notification-panel">
                    <h3>üì¢ Send Notification</h3>
                    <div class="form-group">
                        <select id="notificationTarget">
                            <option value="all">All Users</option>
                            <option value="premium">Premium Users</option>
                            <option value="free">Free Users</option>
                            <option value="inactive">Inactive Users</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <textarea id="notificationMessage" placeholder="Enter notification message..." rows="3"></textarea>
                    </div>
                    <button class="btn btn-info" onclick="sendNotification()">üì§ Send Notification</button>
                </div>

                <div class="quick-actions">
                    <div class="action-card" onclick="exportUsers()">
                        <h4>üìä Export Data</h4>
                        <p>Download user reports</p>
                    </div>
                    <div class="action-card" onclick="showBulkActions()">
                        <h4>‚ö° Bulk Actions</h4>
                        <p>Manage multiple users</p>
                    </div>
                </div>

                <div id="systemStats">
                    <h3>üìà System Statistics</h3>
                    <div id="additionalStats">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">User Management</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="editName">
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="text" id="editPhone">
                </div>
                <div class="form-group">
                    <label>Institution:</label>
                    <input type="text" id="editInstitution">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="editStatus">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Premium Status:</label>
                    <select id="editPremium">
                        <option value="true">Premium</option>
                        <option value="false">Free</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Session Plans Limit:</label>
                    <input type="number" id="editSessionLimit" min="0">
                </div>
                <div class="form-group">
                    <label>Schemes Limit:</label>
                    <input type="number" id="editSchemesLimit" min="0">
                </div>
                <button class="btn btn-success" onclick="saveUserChanges()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìß Send Personal Message</h3>
                <span class="close" onclick="closeNotificationModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>To: <span id="recipientName"></span></label>
            </div>
            <div class="form-group">
                <label>Message:</label>
                <textarea id="personalMessage" rows="4" placeholder="Enter your message..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="sendPersonalMessage()">üì§ Send Message</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://leonardus437.pythonanywhere.com';
        let allUsers = [];
        let currentEditUser = null;
        let selectedRecipient = null;
        
        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                statusDiv.innerHTML = `‚úÖ Connected - ${data.message} (v${data.version})`;
                statusDiv.className = 'status success';
                return true;
            } catch (error) {
                statusDiv.innerHTML = `‚ùå Connection Failed: ${error.message}`;
                statusDiv.className = 'status error';
                return false;
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                document.getElementById('totalUsers').textContent = stats.total_users;
                document.getElementById('premiumUsers').textContent = stats.premium_users;
                document.getElementById('activeUsers').textContent = stats.active_users;
                document.getElementById('totalDownloads').textContent = stats.total_downloads;
                
                document.getElementById('additionalStats').innerHTML = `
                    <p><strong>Free Users:</strong> ${stats.total_users - stats.premium_users}</p>
                    <p><strong>Inactive Users:</strong> ${stats.total_users - stats.active_users}</p>
                    <p><strong>Average Downloads:</strong> ${Math.round(stats.total_downloads / stats.total_users) || 0}</p>
                `;
            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            try {
                const response = await fetch(`${API_BASE}/users/`);
                allUsers = await response.json();
                
                if (allUsers.length === 0) {
                    usersList.innerHTML = '<p>No users found</p>';
                    return;
                }
                
                displayUsers(allUsers);
                
            } catch (error) {
                usersList.innerHTML = `
                    <div class="status error">
                        <strong>Error loading users:</strong> ${error.message}<br>
                        <button class="btn btn-primary" onclick="loadUsers()" style="margin-top: 1rem;">üîÑ Retry</button>
                    </div>
                `;
            }
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-name">
                            ${user.name} 
                            ${user.role === 'admin' ? '<span class="badge badge-admin">Admin</span>' : ''}
                            ${user.is_premium ? '<span class="badge badge-premium">Premium</span>' : ''}
                            ${user.is_active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>'}
                        </div>
                        <div class="user-details">
                            üìû ${user.phone} | üè´ ${user.institution}<br>
                            üìä Plans: ${user.session_plans_downloaded}/${user.session_plans_limit} | 
                            üìö Schemes: ${user.schemes_downloaded}/${user.schemes_limit}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUser('${user.phone}')">‚úèÔ∏è Edit</button>
                        <button class="btn ${user.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleUserStatus('${user.phone}', ${!user.is_active})">
                            ${user.is_active ? 'üö´ Deactivate' : '‚úÖ Activate'}
                        </button>
                        <button class="btn btn-info" onclick="sendMessageToUser('${user.phone}', '${user.name}')">üìß Message</button>
                        <button class="btn ${user.is_premium ? 'btn-warning' : 'btn-success'}" onclick="togglePremium('${user.phone}', ${!user.is_premium})">
                            ${user.is_premium ? '‚≠ê Remove Premium' : 'üíé Grant Premium'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editUser(phone) {
            const user = allUsers.find(u => u.phone === phone);
            if (!user) return;
            
            currentEditUser = user;
            document.getElementById('modalTitle').textContent = `Edit User: ${user.name}`;
            document.getElementById('editName').value = user.name;
            document.getElementById('editPhone').value = user.phone;
            document.getElementById('editInstitution').value = user.institution;
            document.getElementById('editStatus').value = user.is_active.toString();
            document.getElementById('editPremium').value = user.is_premium.toString();
            document.getElementById('editSessionLimit').value = user.session_plans_limit;
            document.getElementById('editSchemesLimit').value = user.schemes_limit;
            
            document.getElementById('userModal').style.display = 'block';
        }

        async function saveUserChanges() {
            if (!currentEditUser) return;
            
            const updatedUser = {
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                institution: document.getElementById('editInstitution').value,
                is_active: document.getElementById('editStatus').value === 'true',
                is_premium: document.getElementById('editPremium').value === 'true',
                session_plans_limit: parseInt(document.getElementById('editSessionLimit').value),
                schemes_limit: parseInt(document.getElementById('editSchemesLimit').value)
            };
            
            try {
                const response = await fetch(`${API_BASE}/users/${currentEditUser.phone}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedUser)
                });
                
                if (response.ok) {
                    showStatus('User updated successfully!', 'success');
                    closeModal();
                    await loadUsers();
                    await loadStats();
                } else {
                    showStatus('Failed to update user', 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function toggleUserStatus(phone, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/users/${phone}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                if (response.ok) {
                    showStatus(`User ${newStatus ? 'activated' : 'deactivated'} successfully!`, 'success');
                    await loadUsers();
                    await loadStats();
                } else {
                    showStatus('Failed to update user status', 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function togglePremium(phone, isPremium) {
            try {
                const response = await fetch(`${API_BASE}/users/${phone}/premium`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_premium: isPremium })
                });
                
                if (response.ok) {
                    showStatus(`Premium status ${isPremium ? 'granted' : 'removed'} successfully!`, 'success');
                    await loadUsers();
                    await loadStats();
                } else {
                    showStatus('Failed to update premium status', 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function sendMessageToUser(phone, name) {
            selectedRecipient = { phone, name };
            document.getElementById('recipientName').textContent = name;
            document.getElementById('personalMessage').value = '';
            document.getElementById('notificationModal').style.display = 'block';
        }

        async function sendPersonalMessage() {
            if (!selectedRecipient) return;
            
            const message = document.getElementById('personalMessage').value.trim();
            if (!message) {
                showStatus('Please enter a message', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/notifications/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipient: selectedRecipient.phone,
                        message: message,
                        type: 'personal'
                    })
                });
                
                if (response.ok) {
                    showStatus(`Message sent to ${selectedRecipient.name}!`, 'success');
                    closeNotificationModal();
                } else {
                    showStatus('Failed to send message', 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function sendNotification() {
            const target = document.getElementById('notificationTarget').value;
            const message = document.getElementById('notificationMessage').value.trim();
            
            if (!message) {
                showStatus('Please enter a notification message', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/notifications/broadcast`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target: target,
                        message: message
                    })
                });
                
                if (response.ok) {
                    showStatus(`Notification sent to ${target} users!`, 'success');
                    document.getElementById('notificationMessage').value = '';
                } else {
                    showStatus('Failed to send notification', 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function exportUsers() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Name,Phone,Institution,Role,Active,Premium,Session Plans,Schemes\n" +
                allUsers.map(user => 
                    `"${user.name}","${user.phone}","${user.institution}","${user.role}","${user.is_active}","${user.is_premium}","${user.session_plans_downloaded}/${user.session_plans_limit}","${user.schemes_downloaded}/${user.schemes_limit}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `rtb_users_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatus('User data exported successfully!', 'success');
        }

        function showBulkActions() {
            showStatus('Bulk actions feature coming soon!', 'warning');
        }

        function showStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            document.querySelector('.header').appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 5000);
        }

        function closeModal() {
            document.getElementById('userModal').style.display = 'none';
            currentEditUser = null;
        }

        function closeNotificationModal() {
            document.getElementById('notificationModal').style.display = 'none';
            selectedRecipient = null;
        }

        // Search functionality
        document.getElementById('searchUsers').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) ||
                user.phone.includes(searchTerm) ||
                user.institution.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const userModal = document.getElementById('userModal');
            const notificationModal = document.getElementById('notificationModal');
            if (event.target === userModal) {
                closeModal();
            }
            if (event.target === notificationModal) {
                closeNotificationModal();
            }
        }

        // Initialize
        async function init() {
            const connected = await testConnection();
            if (connected) {
                await loadStats();
                await loadUsers();
            }
        }

        init();
    </script>
</body>
</html>
                <h3>üìß Send Personal Message</h3>
                <span class="close" onclick="closeNotificationModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>To: <span id="recipientName"></span></label>
            </div>
            <div class="form-group">
                <label>Message:</label>
                <textarea id="personalMessage" rows="4" placeholder="Enter your message..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="sendPersonalMessage()">üì§ Send Message</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://leonardus437.pythonanywhere.com';
        
        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                statusDiv.innerHTML = `‚úÖ Connected - ${data.message} (v${data.version})`;
                statusDiv.className = 'status success';
                return true;
            } catch (error) {
                statusDiv.innerHTML = `‚ùå Connection Failed: ${error.message}`;
                statusDiv.className = 'status error';
                return false;
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                document.getElementById('totalUsers').textContent = stats.total_users;
                document.getElementById('premiumUsers').textContent = stats.premium_users;
                document.getElementById('activeUsers').textContent = stats.active_users;
                document.getElementById('totalDownloads').textContent = stats.total_downloads;
            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            try {
                const response = await fetch(`${API_BASE}/users/`);
                const users = await response.json();
                
                if (users.length === 0) {
                    usersList.innerHTML = '<p>No users found</p>';
                    return;
                }
                
                usersList.innerHTML = users.map(user => `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-name">${user.name} ${user.role === 'admin' ? 'üëë' : ''}</div>
                            <div class="user-details">
                                üìû ${user.phone} | üè´ ${user.institution}<br>
                                üìä Plans: ${user.session_plans_downloaded}/${user.session_plans_limit} | 
                                üìö Schemes: ${user.schemes_downloaded}/${user.schemes_limit} |
                                ${user.is_premium ? '‚≠ê Premium' : 'üÜì Free'}
                            </div>
                        </div>
                        <button class="btn" onclick="alert('User: ${user.name}\\nPhone: ${user.phone}\\nRole: ${user.role}\\nActive: ${user.is_active}')">
                            Details
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                usersList.innerHTML = `
                    <div class="status error">
                        <strong>Error loading users:</strong> ${error.message}<br>
                        <button class="btn" onclick="loadUsers()" style="margin-top: 1rem;">üîÑ Retry</button>
                    </div>
                `;
            }
        }

        // Initialize
        async function init() {
            const connected = await testConnection();
            if (connected) {
                await loadStats();
                await loadUsers();
            }
        }

        init();
    </script>
</body>
</html>