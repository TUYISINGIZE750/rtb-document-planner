<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheme of Work  - RTB</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="subscription-modal.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: rgba(255, 255, 255, 0.95); padding: 1.5rem 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; text-align: center; }
        .header h1 { background: linear-gradient(135deg, #6366f1, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2rem; font-weight: 700; }
        .main-container { flex: 1; display: flex; max-width: 1400px; width: 100%; margin: 2rem auto; gap: 2rem; padding: 0 2rem; height: calc(100vh - 200px); }
        .sidebar { width: 300px; background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow-y: auto; }
        .step-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s; }
        .step-item:hover { background: #f1f5f9; }
        .step-item.active { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; }
        .step-number { width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; }
        .step-item.active .step-number { background: white; color: #6366f1; }
        .step-item.completed .step-number { background: #10b981; color: white; }
        .step-title { font-size: 0.875rem; font-weight: 500; }
        .content-area { flex: 1; background: white; border-radius: 1rem; padding: 3rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow-y: auto; max-height: calc(100vh - 200px); }
        .step-content { display: none; }
        .step-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin: 2rem 0; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #334155; font-size: 0.875rem; }
        input, textarea, select { width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 1rem; transition: all 0.3s; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .btn-group { display: flex; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e2e8f0; }
        .btn { padding: 0.875rem 2rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); }
        .btn-secondary { background: #e2e8f0; color: #334155; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        h2 { font-size: 1.875rem; color: #1e293b; margin-bottom: 0.5rem; }
        .step-description { color: #64748b; margin-bottom: 2rem; }
        .notification { position: fixed; top: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 500; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1000; transform: translateX(400px); transition: transform 0.3s; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #10b981, #059669); }
        .notification.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .progress-bar { height: 4px; background: #e2e8f0; border-radius: 2px; margin-bottom: 2rem; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #06b6d4); transition: width 0.3s; }
        .footer { background: rgba(255, 255, 255, 0.95); padding: 2rem; text-align: center; box-shadow: 0 -4px 6px rgba(0,0,0,0.1); margin-top: 2rem; }
        .footer-content { max-width: 1200px; margin: 0 auto; }
        .footer h3 { color: #1e293b; font-size: 1.25rem; margin-bottom: 1rem; }
        .footer-info { display: flex; justify-content: center; gap: 3rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .footer-item { text-align: left; }
        .footer-item strong { display: block; color: #6366f1; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .footer-item span { color: #64748b; font-size: 0.875rem; }
        .copyright { color: #94a3b8; font-size: 0.875rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="header">
        <a href="teacher-dashboard.html" class="btn btn-secondary" style="position: absolute; left: 2rem; top: 50%; transform: translateY(-50%); text-decoration: none;"><i class="fas fa-arrow-left"></i> Back</a>
        <h1><i class="fas fa-clipboard-list"></i> RTB Document Planner</h1>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <h3 style="margin-bottom: 1.5rem; color: #1e293b; font-size: 1.125rem;">Steps</h3>
            <div class="step-item active" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <div class="step-title">Institution Info</div>
            </div>
            <div class="step-item" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <div class="step-title">Term 1</div>
            </div>
            <div class="step-item" onclick="goToStep(3)">
                <div class="step-number">3</div>
                <div class="step-title">Term 2</div>
            </div>
            <div class="step-item" onclick="goToStep(4)">
                <div class="step-number">4</div>
                <div class="step-title">Term 3</div>
            </div>
            <div class="step-item" onclick="goToStep(5)">
                <div class="step-number">5</div>
                <div class="step-title">Sign-Offs</div>
            </div>
            <div class="step-item" onclick="goToStep(6)">
                <div class="step-number">6</div>
                <div class="step-title">Review</div>
            </div>
        </div>
        
        <div class="content-area">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 12.5%"></div>
            </div>
            
            <form id="wizardForm">
                <!-- Step 1: Institution -->
                <div class="step-content active" data-step="1">
                    <h2>School Details & Module Information</h2>
                    <p class="step-description">School information and module details</p>
                    
                    <div class="form-group full-width"><label>School Logo (Optional)</label><input type="file" id="schoolLogo" accept="image/*" onchange="handleLogoUpload(event)"></div>
                    <div class="form-group full-width"><label>School Name</label><input type="text" name="school_name" placeholder="e.g., IPRC Kigali" required></div>
                    
                    <div class="form-grid">
                        <div class="form-group"><label>Province</label><select name="province" id="provinceSelect" required><option value="">Select Province</option></select></div>
                        <div class="form-group"><label>District</label><select name="district" id="districtSelect" required><option value="">Select District</option></select></div>
                        <div class="form-group"><label>Sector</label><select name="sector_location" id="sectorSelect" required><option value="">Select Sector</option></select></div>
                        <div class="form-group"><label>Cell</label><select name="cell" id="cellSelect" required><option value="">Select Cell</option></select></div>
                        <div class="form-group"><label>Village</label><select name="village" id="villageSelect" required><option value="">Select Village</option></select></div>
                        <div class="form-group"><label>Sector (Trade)</label><input type="text" name="sector" placeholder="e.g., ICT & MULTIMEDIA" required></div>
                        <div class="form-group"><label>Trade</label><input type="text" name="trade" placeholder="e.g., Software Development" required></div>
                        <div class="form-group"><label>Qualification Title</label><input type="text" name="qualification_title" placeholder="e.g., Diploma in Software Development" required></div>
                        <div class="form-group"><label>RQF Level</label><select name="rqf_level" required><option value="">Select</option><option value="Level 1">Level 1</option><option value="Level 2">Level 2</option><option value="Level 3">Level 3</option><option value="Level 4">Level 4</option><option value="Level 5">Level 5</option><option value="Level 6">Level 6</option></select></div>
                        <div class="form-group"><label>Module Code & Title</label><input type="text" name="module_code_title" placeholder="e.g., CSA-M01: C Programming" required></div>
                        <div class="form-group"><label>School Year</label><input type="text" name="school_year" placeholder="e.g., 2024-2025" required></div>
                        <div class="form-group"><label>Term(s)</label><input type="text" name="terms" placeholder="e.g., Term 1, 2, 3" required></div>
                        <div class="form-group"><label>Module Hours</label><input type="number" name="module_hours" placeholder="e.g., 120" required></div>
                        <div class="form-group"><label>Number of Classes</label><input type="number" name="number_of_classes" placeholder="e.g., 3" required></div>
                        <div class="form-group"><label>Class Name</label><input type="text" name="class_name" placeholder="e.g., L4CSA-A" required></div>
                        <div class="form-group"><label>Trainer Name</label><input type="text" name="trainer_name" placeholder="e.g., John Doe" required></div>
                    </div>
                    <div class="btn-group"><button type="button" class="btn btn-primary" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button></div>
                </div>
                
                <!-- Step 2: Term 1 -->
                <div class="step-content" data-step="2">
                    <h2>Term 1 Planning</h2>
                    <p class="step-description">Define learning outcomes and content for Term 1</p>
                    
                    <div class="form-group"><label>Weeks</label><input type="text" name="term1_weeks" placeholder="e.g., 1-12" required></div>
                    <div class="form-group"><label>Competence Code and Name</label><input type="text" name="term1_competence" placeholder="e.g., C1: Programming Fundamentals" required></div>
                    <div class="form-group"><label>Learning Outcomes (one per line)</label><textarea name="term1_learning_outcomes" rows="4" placeholder="LO1: Understand basic programming concepts&#10;LO2: Write simple programs" required></textarea></div>
                    <div class="form-group"><label>Duration</label><input type="text" name="term1_duration" placeholder="e.g., 40 hours" required></div>
                    <div class="form-group full-width"><label>Indicative Content (one per line)</label><textarea name="term1_indicative_contents" rows="4" placeholder="IC1.1: Variables and data types&#10;IC1.2: Control structures&#10;IC1.3: Functions" required></textarea></div>
                    
                    <div class="btn-group"><button type="button" class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Previous</button><button type="button" class="btn btn-primary" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button></div>
                </div>
                
                <!-- Step 5: Term 3 -->
                <div class="step-content" data-step="3">
                    <h2>Term 2 Planning</h2>
                    <p class="step-description">Define learning outcomes and content for Term 2</p>
                    
                    <div class="form-group"><label>Weeks</label><input type="text" name="term2_weeks" placeholder="e.g., 13-24" required></div>
                    <div class="form-group"><label>Competence Code and Name</label><input type="text" name="term2_competence" placeholder="e.g., C2: Advanced Programming" required></div>
                    <div class="form-group"><label>Learning Outcomes (one per line)</label><textarea name="term2_learning_outcomes" rows="4" placeholder="LO3: Apply advanced concepts&#10;LO4: Develop complex programs" required></textarea></div>
                    <div class="form-group"><label>Duration</label><input type="text" name="term2_duration" placeholder="e.g., 40 hours" required></div>
                    <div class="form-group full-width"><label>Indicative Content (one per line)</label><textarea name="term2_indicative_contents" rows="4" placeholder="IC2.1: Object-oriented programming&#10;IC2.2: Data structures&#10;IC2.3: Algorithms" required></textarea></div>
                    
                    <div class="btn-group"><button type="button" class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Previous</button><button type="button" class="btn btn-primary" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button></div>
                </div>
                
                <!-- Step 5: Sign-Offs -->
                <div class="step-content" data-step="4">
                    <h2>Term 3 Planning</h2>
                    <p class="step-description">Define learning outcomes and content for Term 3</p>
                    
                    <div class="form-group"><label>Weeks</label><input type="text" name="term3_weeks" placeholder="e.g., 25-36" required></div>
                    <div class="form-group"><label>Competence Code and Name</label><input type="text" name="term3_competence" placeholder="e.g., C3: Project Development" required></div>
                    <div class="form-group"><label>Learning Outcomes (one per line)</label><textarea name="term3_learning_outcomes" rows="4" placeholder="LO5: Design complete projects&#10;LO6: Implement solutions" required></textarea></div>
                    <div class="form-group"><label>Duration</label><input type="text" name="term3_duration" placeholder="e.g., 40 hours" required></div>
                    <div class="form-group full-width"><label>Indicative Content (one per line)</label><textarea name="term3_indicative_contents" rows="4" placeholder="IC3.1: Project planning&#10;IC3.2: Implementation&#10;IC3.3: Testing and deployment" required></textarea></div>
                    
                    <div class="btn-group"><button type="button" class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Previous</button><button type="button" class="btn btn-primary" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button></div>
                </div>
                
                <div class="step-content" data-step="5">
                    <h2>Approvals</h2>
                    <p class="step-description">Names and positions for approval signatures</p>
                    
                    <div class="form-grid">
                        <div class="form-group"><label>Prepared by (Name)</label><input type="text" name="prepared_by_name" placeholder="Trainer name" required></div>
                        <div class="form-group"><label>Position</label><input type="text" name="prepared_by_position" placeholder="e.g., Trainer" required></div>
                        <div class="form-group"><label>Verified by (Name)</label><input type="text" name="verified_by_name" placeholder="DOS name" required></div>
                        <div class="form-group"><label>Position</label><input type="text" name="verified_by_position" placeholder="e.g., Director of Studies" required></div>
                        <div class="form-group"><label>Approved by (Name)</label><input type="text" name="approved_by_name" placeholder="Manager name" required></div>
                        <div class="form-group"><label>Position</label><input type="text" name="approved_by_position" placeholder="e.g., School Manager" required></div>
                    </div>
                    
                    <div class="btn-group"><button type="button" class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Previous</button><button type="button" class="btn btn-primary" onclick="nextStep()">Next <i class="fas fa-arrow-right"></i></button></div>
                </div>
                
                <!-- Step 8: Review -->
                <div class="step-content" data-step="6">
                    <h2>Review & Generate</h2>
                    <p class="step-description">Review your scheme of work and generate the document</p>
                    
                    <div id="reviewContent" style="background: #f8fafc; padding: 2rem; border-radius: 0.5rem; margin: 2rem 0;">
                        <p style="color: #64748b;">Your scheme details will appear here...</p>
                    </div>
                    
                    <div class="btn-group"><button type="button" class="btn btn-secondary" onclick="prevStep()"><i class="fas fa-arrow-left"></i> Previous</button><button type="submit" class="btn btn-success"><i class="fas fa-magic"></i> Generate Scheme of Work</button></div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Config MUST load first before any auth functions -->
    <!-- Cache-busting timestamp forces CDN/browser to fetch fresh code -->
    <script src="config.js"></script>
    <script src="offline-docx-generator.js"></script>
    <script src="auth.js"></script>
    <script src="subscription-modal.js"></script>
    <script src="notifications.js"></script>
    <script src="user-registration.js"></script>
    <script src="location-handler.js"></script>
    <script>
        // Check authentication on page load
        if (!canAccessUserPages()) {
            alert('Please login to access the Scheme of Work Wizard');
            window.location.replace('login.html');
        }
        
        let schoolLogoBase64 = '';
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    schoolLogoBase64 = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        let currentStep = 1;
        const totalSteps = 6;
        
        function goToStep(step) {
            if (step < 1 || step > totalSteps) return;
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.step-content[data-step="${step}"]`).classList.add('active');
            document.querySelectorAll('.step-item')[step - 1].classList.add('active');
            currentStep = step;
            updateProgress();
            if (step === 6) showReview();
        }
        
        function nextStep() {
            if (validateCurrentStep()) {
                document.querySelectorAll('.step-item')[currentStep - 1].classList.add('completed');
                goToStep(currentStep + 1);
            }
        }
        
        function prevStep() { goToStep(currentStep - 1); }
        
        function validateCurrentStep() {
            const currentContent = document.querySelector(`.step-content[data-step="${currentStep}"]`);
            const inputs = currentContent.querySelectorAll('input[required], select[required], textarea[required]');
            for (let input of inputs) {
                if (!input.value.trim()) {
                    input.focus();
                    showNotification('Please fill in all required fields', 'error');
                    return false;
                }
            }
            return true;
        }
        
        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        function showReview() {
            const formData = new FormData(document.getElementById('wizardForm'));
            const data = Object.fromEntries(formData);
            const reviewHTML = `
                <h3 style="margin-bottom: 1rem; color: #1e293b;">Scheme of Work Summary</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.875rem;">
                    <div><strong>School:</strong> ${data.school_name || ''}</div>
                    <div><strong>Sector:</strong> ${data.sector || ''}</div>
                    <div><strong>Module:</strong> ${data.module_code_title || ''}</div>
                    <div><strong>Level:</strong> ${data.rqf_level || ''}</div>
                    <div><strong>Trainer:</strong> ${data.trainer_name || ''}</div>
                    <div><strong>Year:</strong> ${data.school_year || ''}</div>
                </div>
            `;
            document.getElementById('reviewContent').innerHTML = reviewHTML;
        }
        
        document.getElementById('wizardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check authentication
            const session = getCurrentSession();
            if (!session) {
                alert('Please login to create documents');
                window.location.href = 'login.html';
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                // Add user phone and school logo
                data.user_phone = session.phone;
                if (schoolLogoBase64) {
                    data.school_logo = schoolLogoBase64;
                }
                
                // First check download limits
                const canDownload = await checkDownloadLimits('scheme');
                if (!canDownload) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                const response = await fetch(`${API_BASE}/schemes`, {
                    method: 'POST',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const scheme = await response.json();
                    console.log('Created scheme:', scheme);
                    
                    if (scheme && scheme.id) {
                        // Download the document using fetch to get blob
                        const downloadUrl = `${API_BASE}/schemes-of-work/${scheme.id}/download?phone=${encodeURIComponent(session.phone)}`;
                        
                        try {
                            const downloadResponse = await fetch(downloadUrl);
                            if (downloadResponse.ok) {
                                const blob = await downloadResponse.blob();
                                const url = window.URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = `RTB_Scheme_of_Work_${data.module_code_title || scheme.id}.docx`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(url);
                                
                                showNotification('Scheme of work created and downloaded successfully!', 'success');
                                
                                // Update download counter
                                updateDownloadCounter();
                                
                                // Redirect back to dashboard after a delay
                                setTimeout(() => {
                                    window.location.href = 'teacher-dashboard.html';
                                }, 2000);
                            } else {
                                showNotification('Document created but download failed. Please try from dashboard.', 'error');
                            }
                        } catch (downloadError) {
                            console.error('Download error:', downloadError);
                            showNotification('Document created but download failed. Please try from dashboard.', 'error');
                        }
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    
                    if (errorData.detail && errorData.detail.includes('Download limit reached')) {
                        showSubscriptionModal('schemes');
                    } else {
                        showNotification('Error creating scheme: ' + (errorData.detail || 'Please try again'), 'error');
                    }
                }
                
            } catch (error) {
                console.error('Error in form submission:', error);
                showNotification('Connection error. Please try again.', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // Check download limits before creating document
        async function checkDownloadLimits(type) {
            try {
                const session = getCurrentSession();
                if (!session) return false;
                
                const response = await fetch(`${API_BASE}/user-limits/${encodeURIComponent(session.phone)}`);
                if (response.ok) {
                    const limits = await response.json();
                    
                    if (limits.is_premium) return true; // Premium users have unlimited access
                    
                    if (type === 'scheme' && limits.schemes_remaining <= 0) {
                        showSubscriptionModal('schemes');
                        return false;
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Error checking limits:', error);
            }
            return true;
        }
        
        // Update download counter display
        async function updateDownloadCounter() {
            try {
                const session = getCurrentSession();
                if (!session) return;
                
                const response = await fetch(`${API_BASE}/user-limits/${encodeURIComponent(session.phone)}`);
                if (response.ok) {
                    const limits = await response.json();
                    console.log('Updated limits:', limits);
                }
            } catch (error) {
                console.error('Error updating counter:', error);
            }
        }
        

        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
    </script>
    <script src="chat-widget.js"></script>
    
    <div class="footer">
        <div class="footer-content">
            
            
            <div class="copyright">
                Â© 2025 RTB Document Planner. All rights reserved. | Developed for TVET Excellence
            </div>
        </div>
    </div>
</body>
</html>
