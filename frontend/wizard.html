<!DOCTYPE html>
<html>
<head>
    <title>Session Plan Wizard - Fixed</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 2rem; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 2rem; text-align: center; }
        .user-info { background: #e0f2fe; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; border-left: 4px solid #0ea5e9; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151; }
        input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .btn { padding: 1rem 2rem; border: none; border-radius: 0.5rem; cursor: pointer; margin: 1rem 0.5rem 0 0; font-weight: 600; font-size: 1rem; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .error { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
        .success { color: #10b981; font-size: 0.875rem; margin-top: 0.25rem; }
    </style>
</head>
<body>
    <div class="container">
        <div id="userInfo" class="user-info">
            <strong><i class="fas fa-user"></i> Logged in as:</strong> <span id="userName">Loading...</span>
        </div>
        
        <h1><i class="fas fa-chalkboard-teacher"></i> Session Plan Wizard</h1>
        
        <form id="sessionForm">
            <div class="form-grid">
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Sector *</label>
                    <input type="text" name="sector" required placeholder="e.g., ICT & MULTIMEDIA">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tools"></i> Trade *</label>
                    <input type="text" name="trade" required placeholder="e.g., Software Development">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-layer-group"></i> RQF Level *</label>
                    <select name="rqf_level" required>
                        <option value="">Select Level</option>
                        <option value="Level 1">Level 1</option>
                        <option value="Level 2">Level 2</option>
                        <option value="Level 3">Level 3</option>
                        <option value="Level 4">Level 4</option>
                        <option value="Level 5">Level 5</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user-tie"></i> Teacher Name *</label>
                    <input type="text" name="trainer_name" required placeholder="e.g., John Doe">
                </div>
                <div class="form-group full-width">
                    <label><i class="fas fa-book"></i> Module Code & Title *</label>
                    <input type="text" name="module_code_title" required placeholder="e.g., CSA-M01: Introduction to Programming">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar"></i> Term *</label>
                    <select name="term" required>
                        <option value="">Select Term</option>
                        <option value="Term 1">Term 1</option>
                        <option value="Term 2">Term 2</option>
                        <option value="Term 3">Term 3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar-week"></i> Week *</label>
                    <input type="text" name="week" required placeholder="e.g., Week 4">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar-day"></i> Date *</label>
                    <input type="date" name="date" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-users"></i> Number of Trainees *</label>
                    <input type="number" name="number_of_trainees" required min="1" placeholder="e.g., 25">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Class Name *</label>
                    <input type="text" name="class_name" required placeholder="e.g., L4CSA-A">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-clock"></i> Duration (minutes) *</label>
                    <input type="number" name="duration" required min="40" max="120" value="40">
                </div>
            </div>
            
            <div class="form-group full-width">
                <label><i class="fas fa-bullseye"></i> Topic of Session *</label>
                <input type="text" name="topic_of_session" required placeholder="e.g., Variables and Data Types">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-target"></i> Learning Outcomes *</label>
                <textarea name="learning_outcomes" rows="3" required placeholder="Describe what learners will be able to do after this session..."></textarea>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-list-ul"></i> Indicative Contents *</label>
                <textarea name="indicative_contents" rows="3" required placeholder="‚Ä¢ Key point 1&#10;‚Ä¢ Key point 2&#10;‚Ä¢ Key point 3"></textarea>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-chalkboard-teacher"></i> Facilitation Techniques</label>
                <select name="facilitation_techniques">
                    <option value="">Select Technique</option>
                    <option value="Brainstorming">Brainstorming</option>
                    <option value="Trainer Guided">Trainer Guided</option>
                    <option value="Group Discussion">Group Discussion</option>
                    <option value="Simulation">Simulation</option>
                    <option value="Experiential Learning">Experiential Learning</option>
                    <option value="Jigsaw">Jigsaw</option>
                </select>
            </div>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
                <button type="button" onclick="goBack()" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-magic"></i> Generate Session Plan
                </button>
            </div>
        </form>
    </div>

    <script>
        const API_BASE = 'https://leonardus437.pythonanywhere.com';
        let currentUser = null;

        // FIXED: Strict user validation on page load
        function validateUser() {
            try {
                const stored = localStorage.getItem('rtb_user');
                if (!stored) {
                    throw new Error('No user data found');
                }

                const user = JSON.parse(stored);
                if (!user || !user.name || user.name.trim() === '' || !user.phone) {
                    throw new Error('Invalid user data');
                }

                currentUser = user;
                console.log('‚úÖ User validated:', user.name);
                
                // Display user info
                document.getElementById('userName').textContent = `${user.name} (${user.phone})`;
                
                return user;
            } catch (error) {
                console.error('‚ùå User validation failed:', error);
                alert('Please login first to access this page');
                window.location.href = 'index_fixed.html';
                return null;
            }
        }

        function goBack() {
            window.location.href = 'index_fixed.html';
        }

        // Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            // Validate user first
            if (!validateUser()) return;
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
        });

        document.getElementById('sessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Double-check user authentication
            if (!currentUser) {
                alert('Session expired. Please login again.');
                window.location.href = 'index_fixed.html';
                return;
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Validate required fields
            const requiredFields = ['sector', 'trade', 'rqf_level', 'trainer_name', 'module_code_title', 'term', 'week', 'date', 'number_of_trainees', 'class_name', 'duration', 'topic_of_session', 'learning_outcomes', 'indicative_contents'];
            
            for (const field of requiredFields) {
                if (!data[field] || data[field].trim() === '') {
                    alert(`Please fill in the ${field.replace('_', ' ')} field`);
                    document.querySelector(`[name="${field}"]`).focus();
                    return;
                }
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            btn.disabled = true;

            try {
                console.log('üöÄ Creating session plan with data:', data);

                const response = await fetch(`${API_BASE}/session-plans`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('üì° Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Session plan created:', result);
                    
                    alert('‚úÖ Session plan created successfully!');

                    // Check download limits
                    if (result.id) {
                        try {
                            const limitsResponse = await fetch(`${API_BASE}/user-limits/${encodeURIComponent(currentUser.phone)}`);
                            if (limitsResponse.ok) {
                                const limits = await limitsResponse.json();
                                
                                if (!limits.is_premium && limits.session_plans_remaining <= 0) {
                                    alert('‚ùå Free download limit reached!\n\nUpgrade to Premium for unlimited downloads.\n\nContact: +250789751597');
                                    return;
                                }
                            }
                        } catch (e) {
                            console.error('Error checking limits:', e);
                        }

                        const link = document.createElement('a');
                        link.href = `${API_BASE}/session-plans/${result.id}/download?phone=${encodeURIComponent(currentUser.phone)}`;
                        link.download = `RTB_Session_Plan_${result.id}.docx`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        setTimeout(() => {
                            alert('üìÑ Document downloaded successfully!');
                        }, 1000);
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('‚ùå Creation failed:', errorData);
                    alert(`‚ùå Error creating session plan:\n${errorData.detail || 'Please try again'}`);
                }
            } catch (error) {
                console.error('üí• Error:', error);
                alert(`üí• Connection error:\n${error.message}\n\nPlease check your internet connection and try again.`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>