<!DOCTYPE html>
<html>
<head>
    <title>Session Plan Wizard - Fixed</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="subscription-modal.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 2rem; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 2rem; text-align: center; }
        .user-info { background: #e0f2fe; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; border-left: 4px solid #0ea5e9; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151; }
        input, textarea, select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .btn { padding: 1rem 2rem; border: none; border-radius: 0.5rem; cursor: pointer; margin: 1rem 0.5rem 0 0; font-weight: 600; font-size: 1rem; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .error { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
        .success { color: #10b981; font-size: 0.875rem; margin-top: 0.25rem; }
    </style>
</head>
<body>
    <div class="container">
        <div id="userInfo" class="user-info">
            <strong><i class="fas fa-user"></i> Logged in as:</strong> <span id="userName">Loading...</span>
        </div>
        
        <h1><i class="fas fa-chalkboard-teacher"></i> Session Plan Wizard</h1>
        
        <div id="downloadSection" style="display: none; background: #10b981; color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; text-align: center;">
            <p><i class="fas fa-check-circle"></i> <strong>Session plan created successfully!</strong></p>
            <button id="manualDownloadBtn" class="btn" style="background: white; color: #10b981; margin-top: 0.5rem;">
                <i class="fas fa-download"></i> Click here if download didn't start
            </button>
        </div>
        
        <form id="sessionForm">
            <div class="form-grid">
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Sector *</label>
                    <input type="text" name="sector" required placeholder="e.g., ICT & MULTIMEDIA">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tools"></i> Trade *</label>
                    <input type="text" name="trade" required placeholder="e.g., Software Development">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-layer-group"></i> RQF Level *</label>
                    <select name="rqf_level" required>
                        <option value="">Select Level</option>
                        <option value="Level 1">Level 1</option>
                        <option value="Level 2">Level 2</option>
                        <option value="Level 3">Level 3</option>
                        <option value="Level 4">Level 4</option>
                        <option value="Level 5">Level 5</option>
                        <option value="Level 6">Level 6</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user-tie"></i> Teacher Name *</label>
                    <input type="text" name="trainer_name" required placeholder="e.g., John Doe">
                </div>
                <div class="form-group full-width">
                    <label><i class="fas fa-book"></i> Module Code & Title *</label>
                    <input type="text" name="module_code_title" required placeholder="e.g., CSA-M01: Introduction to Programming">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar"></i> Term *</label>
                    <select name="term" required>
                        <option value="">Select Term</option>
                        <option value="Term 1">Term 1</option>
                        <option value="Term 2">Term 2</option>
                        <option value="Term 3">Term 3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar-week"></i> Week *</label>
                    <input type="text" name="week" required placeholder="e.g., Week 4">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar-day"></i> Date *</label>
                    <input type="date" name="date" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-users"></i> Number of Trainees *</label>
                    <input type="number" name="number_of_trainees" required min="1" placeholder="e.g., 25">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Class Name *</label>
                    <input type="text" name="class_name" required placeholder="e.g., L4CSA-A">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-clock"></i> Duration (minutes) *</label>
                    <input type="number" name="duration" required min="40" max="120" value="40">
                </div>
            </div>
            
            <div class="form-group full-width">
                <label><i class="fas fa-bullseye"></i> Topic of Session *</label>
                <input type="text" name="topic_of_session" required placeholder="e.g., Variables and Data Types">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-target"></i> Learning Outcomes *</label>
                <textarea name="learning_outcomes" rows="3" required placeholder="Describe what learners will be able to do after this session..."></textarea>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-list-ul"></i> Indicative Contents *</label>
                <textarea name="indicative_contents" rows="3" required placeholder="‚Ä¢ Key point 1&#10;‚Ä¢ Key point 2&#10;‚Ä¢ Key point 3"></textarea>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-chalkboard-teacher"></i> Facilitation Techniques</label>
                <select name="facilitation_techniques">
                    <option value="">Select Technique</option>
                    <option value="Brainstorming">Brainstorming</option>
                    <option value="Trainer Guided">Trainer Guided</option>
                    <option value="Group Discussion">Group Discussion</option>
                    <option value="Simulation">Simulation</option>
                    <option value="Experiential Learning">Experiential Learning</option>
                    <option value="Jigsaw">Jigsaw</option>
                </select>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-users-cog"></i> Range *</label>
                <input type="text" name="range" required placeholder="e.g., All learners in Level 4 Programming class">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-paperclip"></i> Appendix (Optional)</label>
                <textarea name="appendix" rows="2" placeholder="e.g., PPT slides, Task sheets, Assessment rubrics"></textarea>
            </div>
            
            <div class="form-group full-width">
                <label><i class="fas fa-school"></i> School Name *</label>
                <input type="text" name="school_name" required placeholder="e.g., IPRC Kigali">
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label><i class="fas fa-map-marked-alt"></i> Province *</label>
                    <select name="province" id="provinceSelect" required>
                        <option value="">Select Province</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> District *</label>
                    <select name="district" id="districtSelect" required>
                        <option value="">Select District</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-map-pin"></i> Sector *</label>
                    <select name="sector_location" id="sectorSelect" required>
                        <option value="">Select Sector</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-location-arrow"></i> Cell *</label>
                    <select name="cell" id="cellSelect" required>
                        <option value="">Select Cell</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-home"></i> Village *</label>
                    <select name="village" id="villageSelect" required>
                        <option value="">Select Village</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group full-width">
                <label><i class="fas fa-image"></i> School Logo (Optional)</label>
                <input type="file" name="school_logo" accept="image/png,image/jpeg,image/jpg" id="schoolLogoInput">
                <small style="color: #6b7280;">Upload your school logo (PNG, JPG). RTB logo will be added automatically.</small>
            </div>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
                <button type="button" onclick="goBack()" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-magic"></i> Generate Session Plan
                </button>
            </div>
        </form>
    </div>

    <!-- Load required scripts -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="subscription-modal.js"></script>
    <script src="subscription-tracker.js"></script>
    <script src="location-handler.js"></script>
    <script>
        let currentUser = null;

        // Strict user validation on page load
        function validateUser() {
            try {
                const session = getCurrentSession();
                if (!session || !session.name || !session.phone) {
                    throw new Error('No valid session found');
                }

                currentUser = session;
                console.log('‚úÖ User validated:', session.name);
                
                // Display user info
                document.getElementById('userName').textContent = `${session.name} (${session.phone})`;
                
                return session;
            } catch (error) {
                console.error('‚ùå User validation failed:', error);
                alert('Please login first to access this page');
                window.location.href = 'login.html';
                return null;
            }
        }

        function goBack() {
            window.location.href = 'teacher-dashboard.html';
        }

        // Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            // Validate user first
            if (!validateUser()) return;
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
            
            // Initialize subscription tracker
            if (typeof SubscriptionTracker !== 'undefined') {
                new SubscriptionTracker();
            }
        });

        document.getElementById('sessionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Double-check user authentication
            if (!currentUser) {
                alert('Session expired. Please login again.');
                window.location.href = 'login.html';
                return;
            }

            const formData = new FormData(e.target);
            
            // Handle school logo upload
            const schoolLogoFile = document.getElementById('schoolLogoInput').files[0];
            let schoolLogoBase64 = '';
            
            if (schoolLogoFile) {
                try {
                    schoolLogoBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(e);
                        reader.readAsDataURL(schoolLogoFile);
                    });
                    console.log('School logo loaded:', schoolLogoBase64.substring(0, 50));
                } catch (error) {
                    console.error('Error reading logo file:', error);
                }
            }
            
            const data = Object.fromEntries(formData);
            
            // Add user phone, level, and logo
            data.user_phone = currentUser.phone;
            data.level = data.rqf_level;
            data.school_logo = schoolLogoBase64;
            
            // Validate required fields
            const requiredFields = ['sector', 'trade', 'rqf_level', 'trainer_name', 'module_code_title', 'term', 'week', 'date', 'number_of_trainees', 'class_name', 'duration', 'topic_of_session', 'learning_outcomes', 'indicative_contents', 'range', 'school_name', 'province', 'district', 'sector_location', 'cell', 'village'];
            
            for (const field of requiredFields) {
                if (!data[field] || data[field].trim() === '') {
                    alert(`Please fill in the ${field.replace('_', ' ')} field`);
                    document.querySelector(`[name="${field}"]`).focus();
                    return;
                }
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            btn.disabled = true;

            try {
                // First check download limits
                const canDownload = await checkDownloadLimits('session_plan');
                if (!canDownload) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                console.log('üöÄ Creating session plan with data:', data);

                const response = await fetch(`${API_BASE}/session-plans`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('üì° Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Session plan created:', result);
                    
                    if (result.id) {
                        console.log('üîΩ Triggering download for ID:', result.id);
                        
                        // Download the document using fetch + blob
                        const downloadUrl = `${API_BASE}/session-plans/${result.id}/download?phone=${encodeURIComponent(currentUser.phone)}`;
                        console.log('üì• Download URL:', downloadUrl);
                        
                        // Fetch and download as blob
                        try {
                            const downloadResponse = await fetch(downloadUrl);
                            if (downloadResponse.ok) {
                                const blob = await downloadResponse.blob();
                                const url = window.URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = `RTB_Session_Plan_${result.id}_${new Date().getTime()}.docx`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(url);
                                console.log('‚úÖ Download completed via blob');
                                
                                // Show success section with manual download option
                                const downloadSection = document.getElementById('downloadSection');
                                const manualBtn = document.getElementById('manualDownloadBtn');
                                downloadSection.style.display = 'block';
                                manualBtn.onclick = () => {
                                    const link = document.createElement('a');
                                    link.href = downloadUrl;
                                    link.download = `RTB_Session_Plan_${result.id}.docx`;
                                    link.click();
                                };
                                
                                // Scroll to top to show success message
                                window.scrollTo(0, 0);
                            } else {
                                console.error('‚ùå Download failed:', downloadResponse.status);
                                
                                // Show manual download button
                                const downloadSection = document.getElementById('downloadSection');
                                const manualBtn = document.getElementById('manualDownloadBtn');
                                downloadSection.style.display = 'block';
                                downloadSection.style.background = '#f59e0b';
                                downloadSection.querySelector('p').innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Auto-download failed. Click button below:</strong>';
                                manualBtn.onclick = () => window.open(downloadUrl, '_blank');
                                window.scrollTo(0, 0);
                            }
                        } catch (downloadError) {
                            console.error('‚ùå Download error:', downloadError);
                            // Fallback: direct link
                            const link = document.createElement('a');
                            link.href = downloadUrl;
                            link.download = `RTB_Session_Plan_${result.id}.docx`;
                            link.target = '_blank';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // Show manual download button as fallback
                            const downloadSection = document.getElementById('downloadSection');
                            const manualBtn = document.getElementById('manualDownloadBtn');
                            downloadSection.style.display = 'block';
                            manualBtn.onclick = () => window.open(downloadUrl, '_blank');
                            window.scrollTo(0, 0);
                        }
                        
                        // Update download counter
                        updateDownloadCounter();
                        
                        // Redirect back to dashboard after a delay
                        setTimeout(() => {
                            window.location.href = 'teacher-dashboard.html';
                        }, 3000);
                    } else {
                        console.error('‚ùå No ID in response:', result);
                        alert('Session plan created but no ID returned');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('‚ùå Creation failed:', errorData);
                    
                    if (errorData.detail && errorData.detail.includes('Download limit reached')) {
                        showSubscriptionModal('session_plans');
                    } else {
                        alert(`‚ùå Error creating session plan:\n${errorData.detail || 'Please try again'}`);
                    }
                }
            } catch (error) {
                console.error('üí• Error:', error);
                alert(`üí• Connection error:\n${error.message}\n\nPlease check your internet connection and try again.`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        
        // Check download limits before creating document
        async function checkDownloadLimits(type) {
            try {
                const response = await fetch(`${API_BASE}/user-limits/${encodeURIComponent(currentUser.phone)}`);
                if (response.ok) {
                    const limits = await response.json();
                    
                    if (limits.is_premium) return true; // Premium users have unlimited access
                    
                    if (type === 'session_plan' && limits.session_plans_remaining <= 0) {
                        showSubscriptionModal('session_plans');
                        return false;
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Error checking limits:', error);
            }
            return true;
        }
        
        // Update download counter display
        async function updateDownloadCounter() {
            try {
                const response = await fetch(`${API_BASE}/user-limits/${encodeURIComponent(currentUser.phone)}`);
                if (response.ok) {
                    const limits = await response.json();
                    console.log('Updated limits:', limits);
                }
            } catch (error) {
                console.error('Error updating counter:', error);
            }
        }
    </script>
</body>
</html>